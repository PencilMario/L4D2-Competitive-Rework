name: Compile Plugins and Release

on:
  push:
    branches:
      - master
    paths:
      - 'addons/sourcemod/scripting/**/*.sp'
      - 'addons/sourcemod/scripting/**/*.inc'
  workflow_dispatch:

jobs:
  build-and-release:
    name: Compile plugins and create release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set environment variables
        run: |
          echo "SCRIPTS_PATH=$GITHUB_WORKSPACE/addons/sourcemod/scripting" >> $GITHUB_ENV
          echo "PLUGINS_PATH=$GITHUB_WORKSPACE/addons/sourcemod/plugins" >> $GITHUB_ENV

      - name: Setup SourcePawn Compiler 1.12
        uses: rumblefrog/setup-sp@master
        with:
          version: "1.12"

      - name: Create compile output directory
        run: mkdir -p "${{ env.SCRIPTS_PATH }}/compiled"

      - name: Compile all plugins
        run: |
          errors=0
          compiled_count=0

          # Find all .sp files in scripting directory (including subdirectories)
          find . -name "*.sp" -type f | while read -r file; do
            # Skip archive, dev_plugins, and other non-compilable directories
            if [[ "$file" == *"/archive/"* ]] || [[ "$file" == *"/dev_plugins/"* ]] || [[ "$file" == *"/testsuite/"* ]]; then
              echo "Skipping archived/test file: $file"
              continue
            fi

            # Get the basename without extension
            filename=$(basename "$file" .sp)
            output_file="${filename}.smx"

            echo "Compiling $file -> $output_file"
            spcomp -E -w234 -w217 -O2 -v2 -i "${{ env.SCRIPTS_PATH }}/include" "$file" -o "${{ env.SCRIPTS_PATH }}/compiled/$output_file" || {
              echo "ERROR: Failed to compile $file"
              errors=$((errors + 1))
              continue
            }
            compiled_count=$((compiled_count + 1))
          done

          if [ "$errors" -gt 0 ]; then
            echo "$errors plugin(s) failed to compile."
            exit 1
          else
            echo "Successfully compiled $compiled_count plugins."
          fi
        working-directory: ${{ env.SCRIPTS_PATH }}/

      - name: Prepare release artifacts
        run: |
          # Create a temporary directory for release artifacts
          mkdir -p release_artifacts

          # Copy all compiled .smx files to release artifacts directory
          find "${{ env.SCRIPTS_PATH }}/compiled" -name "*.smx" -type f | while read -r file; do
            cp "$file" release_artifacts/
          done

          # Create a summary file
          {
            echo "# Compiled Plugins Summary"
            echo ""
            echo "**Compilation Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "## Compiled Plugins"
            ls -lh release_artifacts/*.smx | awk '{print "- " $9 " (" $5 ")"}' | sed 's|release_artifacts/||'
            echo ""
            echo "Total: $(ls -1 release_artifacts/*.smx 2>/dev/null | wc -l) plugins"
          } > release_artifacts/MANIFEST.txt

          cat release_artifacts/MANIFEST.txt

      - name: Generate release notes
        id: release_notes
        run: |
          release_date=$(date '+%Y-%m-%d')
          release_tag="v$(date '+%Y%m%d-%H%M%S')"
          echo "release_date=$release_date" >> $GITHUB_OUTPUT
          echo "release_tag=$release_tag" >> $GITHUB_OUTPUT

          # Generate release notes with compilation summary
          {
            echo "# Plugin Compilation Release"
            echo ""
            echo "**Release Date:** $release_date"
            echo ""
            echo "## Summary"
            echo "This release contains recompiled plugins from the latest source code."
            echo ""
            echo "### Build Information"
            echo "- SourceMod Version: 1.12"
            echo "- Compiler: spcomp with optimization level 2"
            echo "- Optimization Level: 2"
            echo "- Build Date: $(date -u '+%Y-%m-%dT%H:%M:%SZ')"
            echo "- Commit: ${{ github.sha }}"
            echo ""
            echo "### Installation"
            echo "Extract the contents of the release to your server's game directory to replace the compiled plugins."
          } > release_notes.md

          cat release_notes.md
        env:
          TZ: UTC

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.release_notes.outputs.release_tag }}
          name: Plugin Compilation Release ${{ steps.release_notes.outputs.release_date }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: release_artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
